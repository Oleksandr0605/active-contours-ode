# Моделювання активних контурів (Snakes) як динамічної системи: від PDE до програмної реалізації. 
Олександр Іванюк, Петро Прокопець

## Вступ
Задачі сегментації зображень часто викликають труднощі з виділенням об'єктів складної форми. Класичні методи, такі як порогова фільтрація чи детектори країв (Canny, Sobel), працюють локально і часто дають розривчасті межі, особливо за наявності шуму. Тут стають в нагоді активні контури, або "змії" (Snakes), запропоновані Kass, Witkin та Terzopoulos.

Основний виклик полягає у некоректності цієї задачі: реальні зображення містять шум, тіні, оклюзії (перекриття об'єктів) та неоднорідні текстури. Тому ідеальний математичний детектор меж повинен не просто реагувати на зміну кольору, а враховувати апріорну інформацію про геометричну форму об'єкта (наприклад, його гладкість та неперервність).

Головна ідея нашого проєкту полягає в зміні парадигми: замість того, щоб намагатися "знайти" контур за один крок, ми створюємо динамічну модель — замкнену криву, яка еволюціонує у часі. Ми розглядаємо контур не як статичний набір пікселів, а як фізичне тіло (пружну нитку), яке деформується під дією сил. Це дозволяє нам перейти від задачі обробки зображень до задачі аналізу динамічної системи, поведінка якої описується диференціальними рівняннями.

## Огляд класичних підходів
Історично існує декілька класів алгоритмів для вирішення цієї задачі, кожен з яких має суттєві обмеження:
- **Порогові методи та кластеризація**  
Найпростіший підхід — бінаризація зображення за певним порогом яскравості (Global Thresholding). 
Недолік: Цей метод ігнорує просторову структуру. Якщо об'єкт має складну текстуру або освітлення нерівномірне, метод розірве об'єкт на шматки. Він не гарантує замкненості контуру.

- **Локальні виявлення країв (Edge Detectors)**  
Найпоширеніші методи (Sobel, Prewitt, Canny) базуються на обчисленні градієнта інтенсивності $\nabla I$. Вони шукають точки локального максимуму першої похідної (різкі перепади яскравості).
Недолік: ці оператори "бачать" лише найближчі пікселі. Вони не мають поняття про "контур" як цілісний об'єкт. В результаті роботи детектора Canny ми часто отримуємо набір розрізнених пікселів, а не замкнену лінію. Високочастотний шум створює фальшиві градієнти, які локальні методи помилково сприймають як краї.

- **Перетворення Хафа (Hough Transform)**  
Дозволяє знаходити глобальні фігури, але вимагає, щоб ми заздалегідь знали, що шукаємо (коло, лінію, еліпс). 
Недолік: Абсолютно не підходить для сегментації біологічних об'єктів чи довільних форм, які не описуються простими аналітичними рівняннями.

## Опис моделі
Щоб подолати обмеження локальних методів ("сліпоту" до форми) та жорстких шаблонів, у 1988 році Kass, Witkin та Terzopoulos запропонували принципово інший підхід: Deformable Models (Моделі, що деформуються).

Ідея полягає в тому, щоб замінити процес "пошуку пікселів" на процес фізичної еволюції кривої. Ми не скануємо зображення в пошуках країв, а накладаємо на нього початковий замкнений контур (сплайн), який починає змінювати свою форму під дією сил.

Цей підхід елегантно усуває головні недоліки попередніх методів:

- **Гарантія неперервності:** Оскільки ми моделюємо контур як зв'язну нитку, ми завжди отримуємо замкнену межу. У контурі принципово не може бути "дірок", на відміну від детектора Canny.

- **Стійкість до шуму:** Завдяки внутрішнім зв'язкам між точками контуру (імітація пружності), модель ігнорує дрібні шумові сплески. Вона "розуміє", що реальний об'єкт не може мати хаотично викривлену межу.

- **Інтерполяція:** Якщо на зображенні частина межі об'єкта прихована або розмита (нульовий градієнт), активний контур "домальовує" цю ділянку по інерції, прагнучи мінімізувати свою кривизну.

Щоб реалізувати таку "розумну" поведінку, ми відмовляємося від суто геометричного опису і переходимо до фізичної аналогії.

Ми розглядаємо контур як механічну систему — пружну струну, поміщену у в'язке середовище та потенціальне поле сил. Поведінка такої системи природним чином описується методами диференціальних рівнянь та варіаційного числення.

Фундаментально модель базується на варіаційному численні. Ми хочемо знайти таку криву $\mathbf{x}(s) = (x(s), y(s))$, де $s \in [0, 1]$ — параметр довжини дуги, яка мінімізує повну енергію системи:

$$E_{total} = E_{int} + E_{ext}$$

Внутрішня енергія ($E_{int}$) відповідає за геометрію контуру (його плавність). Вона визначається похідними контуру:

$$
E_{int} = \frac{1}{2} \int_0^1 \left( \alpha \left| \frac{\partial \mathbf{x}}{\partial s} \right|^2 + \beta \left| \frac{\partial^2 \mathbf{x}}{\partial s^2} \right|^2 \right) ds
$$

Тут перший доданок ($\alpha$) контролює еластичність (контур хоче стягнутися), а другий ($\beta$) — жорсткість (контур опирається вигину). Зовнішня енергія ($E_{ext}$) прив'язує контур до зображення. Зазвичай це потенціальне поле $P(\mathbf{x})$, яке має мінімуми на краях об'єктів (наприклад, $P = -|\nabla I|^2$, де $I$ — інтенсивність зображення).  
Від мінімізації до диференціального рівняння згідно з варіаційним численням, мінімум цього функціоналу досягається, коли виконується рівняння Ейлера-Лагранжа. Це дає нам баланс сил у стані рівноваги:

$$\alpha \mathbf{x}''(s) - \beta \mathbf{x}''''(s) - \nabla P(\mathbf{x}) = 0
$$
(штрихи позначають похідні по простору $s$).  

Ми використовуємо метод градієнтного спуску, вводячи штучний час $t$. Ми змушуємо контур рухатися в напрямку антиградієнта енергії, доки він не досягне рівноваги. Так ми отримуємо наше основне рівняння в частинних похідних (PDE) 4-го порядку параболічного типу:

$$
\frac{\partial \mathbf{x}}{\partial t} = \underbrace{\alpha \frac{\partial^2 \mathbf{x}}{\partial s^2} - \beta \frac{\partial^4 \mathbf{x}}{\partial s^4}}_{\text{Внутрішні сили (Elasticity + Stiffness)}} + \underbrace{\nabla P(\mathbf{x})}_{\text{Зовнішні сили (Image Force)}}
$$

Отримане рівняння в частинних похідних становить теоретичний базис моделі. Воно дозволяє інтерпретувати задачу сегментації як процес еволюції нескінченновимірної динамічної системи, де основні компоненти мають наступний зміст:

- Фазовий простір: нескінченновимірний функціональний простір усіх можливих гладких замкнених кривих. Кожна точка цього простору відповідає певній конфігурації контуру.
- Атрактор системи: Стаціонарний розв'язок еволюційного рівняння $(\frac{\partial \mathbf{x}}{\partial t} = 0)$. Геометрично це відповідає стану, де внутрішні сили натягу контуру врівноважуються зовнішніми силами градієнта зображення, що збігається з локальним мінімумом енергетичного функціоналу (межами об'єкта).
- Параметри стійкості: коефіцієнти $\alpha$ (ваговий множник другої похідної) та $\beta$ (ваговий множник четвертої похідної) виступають параметрами регуляризації. Вони визначають "гладкість" траєкторії спуску та стійкість системи до високочастотного шуму. 

У подальших розділах буде розглянуто дискретизацію цього неперервного рівняння та його зведення до системи звичайних диференціальних рівнянь.

## Зведення до системи звичайних диференціальних рівнянь
Рівняння часткових похідним зазвичай є доволі важким в аналізі та застосуванні, тому найраще перетворити її на систему звичайних диференціальних рівнянь.
#### Просторова дискретизація
Ми апроксимуємо неперервний контур $\mathbf{x}(s, t)$ набором з $N$ вузлів (дискретних точок):

$$
\mathbf{V} = [\mathbf{v}_1, \mathbf{v}_2, \dots, \mathbf{v}_N]^T
$$

де кожен $\mathbf{v}_i = (x_i(t), y_i(t))$.  
Для апроксимації просторових похідних ми використовуємо скінченні різниці. Друга похідна ($\frac{\partial^2}{\partial s^2}$) у вузлі $i$ апроксимується як:

$$
(\mathbf{v}_{i+1} - 2\mathbf{v}_i + \mathbf{v}_{i-1}) / h^2
$$

Четверта похідна ($\frac{\partial^4}{\partial s^4}$) має вигляд:

$$
(\mathbf{v}_{i+2} - 4\mathbf{v}_{i+1} + 6\mathbf{v}_i - 4\mathbf{v}_{i-1} + \mathbf{v}_{i-2}) / h^4
$$


## Формування матричного оператора
Дискретизація внутрішніх сил для кожного вузла $i$ призводить до лінійного рівняння, що пов'язує координату вузла $\mathbf{v}_i$ з його найближчими сусідами. Для довільного вузла $i$ (де $1 \le i \le N$) умова рівноваги записується як:

$$
a \mathbf{v}_i + b (\mathbf{v}_{i-1} + \mathbf{v}_{i+1}) + c (\mathbf{v}_{i-2} + \mathbf{v}_{i+2}) = \mathbf{F}_{ext}(\mathbf{v}_i)
$$

де коефіцієнти $a, b, c$ визначаються параметрами еластичності $\alpha$ та жорсткості $\beta$.Система з $N$ таких рівнянь може бути записана у матричному вигляді $A\mathbf{V} = \mathbf{F}_{ext}$.  
Структура матриці жорсткості $A$ визначається наступним чином:
1. Діагональна структура: $i$-й рядок матриці містить коефіцієнти рівняння для $i$-го вузла. Елемент головної діагоналі $A_{i,i}$ дорівнює $a$, сусідні елементи $A_{i, i\pm1}$ дорівнюють $b$, а елементи $A_{i, i\pm2}$ дорівнюють $c$.
2. Періодичні граничні умови: Внаслідок замкненості контуру індексація вузлів є циклічною (по модулю $N$). Це означає, що сусідами першого вузла зліва є останні вузли масиву ($\mathbf{v}_N, \mathbf{v}_{N-1}$). У матричному представленні це призводить до появи ненульових елементів у кутах матриці (циклічна стрічка).Таким чином, оператор $A$ є циклічною п'ятидіагональною матрицею (pentadiagonal circulant matrix):$$A =
\begin{bmatrix}
a & b & c & 0 & \dots & 0 & c & b \\
b & a & b & c & \dots & 0 & 0 & c \\
c & b & a & b & \dots & 0 & 0 & 0 \\
\vdots & \vdots & \vdots & \vdots & \ddots & \vdots & \vdots & \vdots \\
0 & 0 & 0 & \dots & b & a & b & c \\
c & 0 & 0 & \dots & c & b & a & b \\
b & c & 0 & \dots & 0 & c & b & a
\end{bmatrix}$$Така структура матриці є розрідженою, що дозволяє використовувати ефективні алгоритми для обернення матриці при чисельному розв'язанні еволюційного рівняння.

## Дискретна динамічна система
В результаті просторової дискретизації рівняння в частинних похідних редукується до системи звичайних диференціальних рівнянь (ЗДР) першого порядку за часом:

$$
\frac{d\mathbf{V}}{dt} = -A\mathbf{V} + \mathbf{F}_{ext}(\mathbf{V})
$$

Отримана система є класичною скінченновимірною динамічною системою, характеристики якої інтерпретуються наступним чином:
- Фазовий простір: На відміну від неперервної моделі, тут фазовим простором виступає скінченновимірний евклідів простір $\mathbb{R}^{2N}$. Стан системи в будь-який момент часу $t$ повністю визначається вектором координат вузлів $\mathbf{V}(t)$.

- Закон еволюції: Векторне поле швидкостей у фазовому просторі задається правою частиною рівняння. Воно складається з лінійної дисипативної компоненти ($-A\mathbf{V}$), що прагне "стягнути" контур, та нелінійної компоненти зовнішніх сил ($\mathbf{F}_{ext}$), що визначається градієнтом зображення.

- Стан рівноваги (Атрактор): Фінальним результатом еволюції є досягнення нерухомої точки (fixed point), де швидкість зміни стану дорівнює нулю: $\dot{\mathbf{V}} = 0$. Це відповідає розв'язку системи алгебраїчних рівнянь $A\mathbf{V} = \mathbf{F}_{ext}$, де внутрішні сили натягу точно врівноважуються силами притягання до меж об'єкта на зображенні.

## Часова дискретизація (Напівнеявна схема)
Для чисельного розв'язання системи звичайних диференціальних рівнянь $\frac{d\mathbf{V}}{dt} = -A\mathbf{V} + \mathbf{F}_{ext}(\mathbf{V})$ необхідно дискретизувати час. Використання явної схеми Ейлера вимагає надзвичайно малого кроку за часом для забезпечення стійкості (через жорсткість члена четвертої похідної). Тому ми застосовуємо напівнеявну схему (semi-implicit scheme), яка є безумовно стійкою.

Дискретизуємо похідну за часом як $\frac{\mathbf{V}^{t+1} - \mathbf{V}^t}{\tau}$ (де $\tau$ — крок часу, у нашій нотації $\gamma$). Внутрішні сили обчислюються на новому кроці $t+1$, а зовнішні — на поточному $t$:

$$
\frac{\mathbf{V}^{t+1} - \mathbf{V}^t}{\gamma} = -A\mathbf{V}^{t+1} + \mathbf{F}_{ext}(\mathbf{V}^t)
$$

Перегрупувавши доданки, отримуємо лінійну систему рівнянь для знаходження координат на наступному кроці:

$$
(I + \gamma A)\mathbf{V}^{t+1} = \mathbf{V}^t + \gamma \mathbf{F}_{ext}(\mathbf{V}^t)
$$

Звідси отримуємо ітераційну формулу еволюції контуру:

$$
\mathbf{V}^{t+1} = (I + \gamma A)^{-1} (\mathbf{V}^t + \gamma \mathbf{F}_{ext}(\mathbf{V}^t))
$$

Матриця $M = (I + \gamma A)^{-1}$ є оператором еволюції (або згладжування), який діє на контур на кожній ітерації. Обернення матриці $(I + \gamma A)$ відбувається швидко, оскільки вона є пентадіагональною.

## Спектральний аналіз оператора еволюції
Розуміння фізичного змісту оператора $M = (I + \gamma A)^{-1}$ є ключовим для аналізу динаміки системи. Оскільки матриця жорсткості $A$ є циркулянтною (через періодичні граничні умови замкненого контуру), її власні вектори утворюють стандартний базис дискретного перетворення Фур'є:

$$
u_k(j) = e^{i 2\pi k j / N}, \quad k = 0, \dots, N-1
$$

Матриця $A$ діагоналізується у цьому базисі: $A = F^{-1} \Lambda F$, де $\Lambda = \mathrm{diag}(\lambda_0, \dots, \lambda_{N-1})$ — діагональна матриця власних чисел. Власні значення $\lambda_k$ для пентадіагональної матриці з коефіцієнтами $(a, b, c)$ визначаються як:

$$
\lambda_k = a + 2b \cos\left(\frac{2\pi k}{N}\right) + 2c \cos\left(\frac{4\pi k}{N}\right)
$$

Відповідно, власні значення оператора еволюції $M$ мають вигляд:

$$
\mu_k = \frac{1}{1 + \gamma \lambda_k}
$$

### Інтерпретація фільтрації частот
Аналіз спектру $\mu_k$ показує, що оператор $M$ діє як фільтр низьких частот (Low-pass filter):
1.  **Низькі частоти ($k \approx 0$):** Власні числа $\lambda_k$ малі, тому $\mu_k \approx 1$. Це означає, що загальна форма контуру (низькочастотна компонента) зберігається майже без змін.
2.  **Високі частоти ($k \approx N/2$):** Власні числа $\lambda_k$ великі, тому $\mu_k \ll 1$. Це призводить до швидкого загасання високочастотного шуму та різких вигинів контуру.

Таким чином, еволюція змії — це ітеративний процес згладжування, що чергується з деформацією під дією сил зображення.

## Аналіз енергії та стійкості (Функція Ляпунова)
Для підтвердження коректності роботи алгоритму ми розглядаємо повну енергію системи як функцію Ляпунова. Повна енергія на кроці $t$ визначається сумою внутрішньої та зовнішньої енергій:

$$
E_{total}(t) = \underbrace{\frac{1}{2}\sum_{i=1}^N (\alpha |\mathbf{v}_i'|^2 + \beta |\mathbf{v}_i''|^2)}_{E_{int}} - \underbrace{\sum_{i=1}^N |\nabla I(\mathbf{v}_i)|}_{E_{ext}}
$$

Чисельні експерименти показують, що при коректному виборі кроку $\gamma$ функція $E_{total}(t)$ монотонно спадає з часом ($dE/dt \le 0$). 
Це гарантує, що динамічна система є дисипативною і з часом сходиться до атрактора — локального мінімуму енергії, який відповідає виділеному контуру об'єкта. Поява осциляцій енергії свідчить про порушення умови стійкості (надто великий крок $\gamma$ або надмірна величина зовнішніх сил).

## Вплив параметрів регуляризації
Поведінка моделі суттєво залежить від балансу коефіцієнтів $\alpha$ та $\beta$:

* **Сценарій A (High $\alpha$, Low $\beta$):** Система поводиться як натягнута гумова стрічка. Контур прагне мінімізувати свою довжину, "зрізаючи" кути та ігноруючи дрібні деталі. У граничному випадку (без зовнішніх сил) контур стягується в точку.
* **Сценарій B (Low $\alpha$, High $\beta$):** Система нагадує пружний металевий дріт. Контур опирається вигину, зберігаючи гладкість навіть на ділянках з високою кривизною. Це дозволяє краще апроксимувати об'єкти складної форми, не стягуючись всередину.

## Обмеження методу та Capture Range
Важливим аспектом дослідження є "басейн притягання" (Capture Range) системи. Оскільки зовнішня сила $\mathbf{F}_{ext} = \nabla P$ залежить від градієнта зображення, вона є локальною.
Якщо початковий контур ініціалізовано далеко від об'єкта, де градієнт $\nabla I \approx 0$, зовнішня сила відсутня. У цьому випадку під дією внутрішніх сил ($\alpha$) змія стиснеться і зникне, так і не "побачивши" об'єкт.
Для розширення області притягання у сучасних реалізаціях використовують поле GVF (Gradient Vector Flow), яке дифундує градієнти на все зображення, проте у даній роботі ми обмежуємось класичною постановкою задачі.

## Висновки
У даній роботі активні контури (Snakes) були проаналізовані та реалізовані як дискретна динамічна система. Ми показали, що:
1.  Задача сегментації може бути ефективно зведена до розв'язання системи лінійних алгебраїчних рівнянь з розрідженою матрицею.
2.  Спектральний аналіз оператора еволюції $(I+\gamma A)^{-1}$ доводить його властивості як низькочастотного фільтра, що забезпечує стійкість до шуму.
3.  Система має чітку енергетичну інтерпретацію: еволюція контуру є градієнтним спуском по поверхні повної енергії.

Таким чином, запропонований підхід поєднує строгість диференціальних рівнянь з ефективністю чисельних методів лінійної алгебри, дозволяючи вирішувати некоректно поставлені задачі комп'ютерного зору.